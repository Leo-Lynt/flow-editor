# @flow-forge/core

**Single Source of Truth** para o FlowForge - ContÃ©m toda a lÃ³gica de execuÃ§Ã£o, configuraÃ§Ã£o e definiÃ§Ã£o de nodes.

## ðŸ“¦ O que Ã© o Core?

O Core Ã© o coraÃ§Ã£o do FlowForge. Ele centraliza:

- âœ… **ConfiguraÃ§Ã£o**: nodes.json, mappings.js, dataTypes.json
- âœ… **LÃ³gica de ExecuÃ§Ã£o**: Engines (Flow, Type, AutoExecution)
- âœ… **Methods**: 35+ implementaÃ§Ãµes de nodes (processors, connectors, logic, etc.)
- âœ… **Utilities**: FunÃ§Ãµes auxiliares (unwrapData, deepClone, etc.)
- âœ… **Interfaces**: Contratos para adapters e extensÃµes

## ðŸ—ï¸ Estrutura

```
packages/core/src/
â”œâ”€â”€ config/              # SINGLE SOURCE OF TRUTH
â”‚   â”œâ”€â”€ nodes.json       # CatÃ¡logo completo de nodes (3611 linhas)
â”‚   â”œâ”€â”€ mappings.js      # Mapeamentos de campos e sourceTypes
â”‚   â””â”€â”€ dataTypes.json   # DefiniÃ§Ãµes de tipos de dados
â”‚
â”œâ”€â”€ methods/             # 35 implementaÃ§Ãµes de nodes
â”‚   â”œâ”€â”€ comparison/      # Nodes de comparaÃ§Ã£o (>, <, ==, etc.)
â”‚   â”œâ”€â”€ connectors/      # Conectores externos (Sheets, APIs, etc.)
â”‚   â”œâ”€â”€ constants/       # Valores constantes
â”‚   â”œâ”€â”€ conversion/      # ConversÃ£o de tipos
â”‚   â”œâ”€â”€ io/              # Input/Output
â”‚   â”œâ”€â”€ iteration/       # Loops (forEach, while)
â”‚   â”œâ”€â”€ logic/           # LÃ³gica condicional
â”‚   â”œâ”€â”€ organization/    # Markers e organizaÃ§Ã£o visual
â”‚   â”œâ”€â”€ processors/      # 22 processadores (arrays, objects, math, etc.)
â”‚   â”œâ”€â”€ storage/         # VariÃ¡veis e storage
â”‚   â””â”€â”€ string/          # OperaÃ§Ãµes com strings
â”‚
â”œâ”€â”€ engine/              # Engines de execuÃ§Ã£o
â”‚   â”œâ”€â”€ FlowEngine.js    # Orquestra execuÃ§Ã£o de flows
â”‚   â”œâ”€â”€ TypeEngine.js    # Sistema de tipos
â”‚   â”œâ”€â”€ AutoExecutionEngine.js  # Auto-execuÃ§Ã£o
â”‚   â”œâ”€â”€ registry.js      # Registro de methods
â”‚   â”œâ”€â”€ loader.js        # Carregador de catÃ¡logo
â”‚   â””â”€â”€ executor.js      # Executor de nodes
â”‚
â”œâ”€â”€ utils/               # UtilitÃ¡rios
â”‚   â””â”€â”€ dataUtils.js     # unwrapData, wrapData
â”‚
â”œâ”€â”€ interfaces/          # Contratos
â”‚   â”œâ”€â”€ IDataSource.js
â”‚   â””â”€â”€ IOutputDestination.js
â”‚
â””â”€â”€ contracts/           # Schemas
    â””â”€â”€ ConnectorConfig.js
```

## ðŸš€ Uso

### No Node.js (API)

```javascript
// CommonJS com dynamic import
const mappings = await import('@flow-forge/core/config/mappings.js')
const { unwrapData } = await import('@flow-forge/core/utils/dataUtils.js')

// Executar method
const method = await import('@flow-forge/core/methods/processors/math.js')
const result = method.add({ inputs: { a: 5, b: 3 } })
```

### No Browser (Frontend via Vite)

```javascript
// ES Modules com alias @flow-forge/core
import { FlowEngine } from '@flow-forge/core'
import { FRONTEND_TO_CANONICAL } from '@flow-forge/core/config/mappings.js'
import { unwrapData } from '@flow-forge/core/utils/dataUtils.js'

const engine = new FlowEngine()
```

## ðŸ“ Arquivos Importantes

### config/nodes.json

CatÃ¡logo completo de todos os nodes disponÃ­veis no FlowForge.

**Estrutura:**
```json
{
  "categories": [
    { "id": "processors", "name": "Processadores", "icon": "âš™ï¸" }
  ],
  "nodes": [
    {
      "type": "math",
      "category": "processors",
      "name": "Math",
      "icon": "âž•",
      "functions": ["add", "subtract", "multiply", "divide"],
      "inputs": [...],
      "outputs": [...]
    }
  ]
}
```

**Como obter:**
- Frontend: `GET /api/nodes` (servido pela API)
- API: LÃª diretamente do arquivo com cache

### config/mappings.js

Mapeamentos de campos entre camadas (Frontend â†’ Canonical â†’ Service).

**Estrutura:**
```javascript
export const FRONTEND_TO_CANONICAL = {
  google_sheets: {
    sheetsUrl: 'spreadsheetUrl',
    sheetsConnectionId: 'connectionId'
  }
}

export const CANONICAL_TO_SERVICE = {
  google_sheets: {
    spreadsheetUrl: 'url',
    connectionId: 'connectionId'
  }
}

export const SOURCE_TYPE_MAPPINGS = {
  toApi: { 'google_sheets': 'sheets' },
  fromApi: { 'sheets': 'google_sheets' }
}
```

### methods/[categoria]/[node].js

ImplementaÃ§Ã£o de cada node.

**Estrutura padrÃ£o:**
```javascript
import { unwrapData } from '../../utils/dataUtils.js'

/**
 * FunÃ§Ã£o principal do node
 * @param {Object} params
 * @param {Object} params.nodeData - ConfiguraÃ§Ã£o do node
 * @param {Object} params.inputs - Inputs recebidos
 * @param {Object} params.context - Contexto de execuÃ§Ã£o
 * @returns {*} Resultado da execuÃ§Ã£o
 */
export function add({ nodeData, inputs, context }) {
  const a = unwrapData(inputs.a)
  const b = unwrapData(inputs.b)
  return a + b
}

/**
 * Valida configuraÃ§Ã£o do node (opcional)
 * @param {Object} nodeData
 * @returns {Object} { valid: boolean, errors: Array }
 */
export function validate(nodeData) {
  return { valid: true, errors: [] }
}
```

## ðŸ”§ Desenvolvimento

### Adicionar Novo Node

Veja [CREATE_NODE.md](./CREATE_NODE.md) para guia completo.

**Resumo rÃ¡pido:**

1. **Criar method** em `methods/[categoria]/[nome].js`
2. **Adicionar definiÃ§Ã£o** em `config/nodes.json`
3. **Atualizar mappings** (se necessÃ¡rio) em `config/mappings.js`

### Executar Tests

```bash
cd packages/core
npm test
```

### Build

```bash
npm run build
```

## ðŸŽ¯ PrincÃ­pios

1. **Zero Dependencies**: Core nÃ£o tem dependÃªncias externas
2. **Pure JavaScript**: Funciona em Node.js e Browser
3. **Single Source of Truth**: Toda configuraÃ§Ã£o estÃ¡ no Core
4. **Stateless Methods**: Methods nÃ£o mantÃ©m estado
5. **Type Safety**: Sistema de tipos robusto

## ðŸ”„ Como outros pacotes usam o Core

### API (Node.js + CommonJS)

```javascript
// Dynamic import para acessar ES Modules do Core
const mappings = await import('@flow-forge/core/config/mappings.js')

// Cache para performance
let CANONICAL_TO_SERVICE_FIELDS = null

async function loadMappingsFromCore() {
  if (!CANONICAL_TO_SERVICE_FIELDS) {
    const mappings = await import('@flow-forge/core/config/mappings.js')
    CANONICAL_TO_SERVICE_FIELDS = mappings.CANONICAL_TO_SERVICE
  }
  return { CANONICAL_TO_SERVICE_FIELDS }
}
```

### Frontend (Browser + Vite)

```javascript
// Vite alias configurado em vite.config.js
import { FlowEngine } from '@flow-forge/core'

// Busca nodes.json via API (nÃ£o importa diretamente)
const response = await fetch('/api/nodes')
const { data: nodes } = await response.json()
```

## ðŸ“š Engines

### FlowEngine

Orquestra execuÃ§Ã£o completa de flows.

```javascript
import { FlowEngine } from '@flow-forge/core'

const engine = new FlowEngine()
engine.setConfig({ apiUrl: 'http://localhost:3001' }, { var1: 'value' })

const result = await engine.executeFlow(nodes, edges)
```

### TypeEngine

Gerencia sistema de tipos e compatibilidade.

```javascript
import { TypeEngine } from '@flow-forge/core'

const typeEngine = new TypeEngine()
const type = typeEngine.detectType('node_1', 'output', { value: 42 })
const compatible = typeEngine.isTypeCompatible('string', 'any') // true
```

### AutoExecutionEngine

Decide quando nodes devem ser auto-executados.

```javascript
import { AutoExecutionEngine } from '@flow-forge/core'

const autoExec = new AutoExecutionEngine()
if (autoExec.shouldAutoExecute('constant', 'create')) {
  // Executar automaticamente
}
```

## ðŸ“„ License

MIT
