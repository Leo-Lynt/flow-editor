# @flow-forge/core

**Single Source of Truth** para o FlowForge - Contém toda a lógica de execução, configuração e definição de nodes.

## 📦 O que é o Core?

O Core é o coração do FlowForge. Ele centraliza:

- ✅ **Configuração**: nodes.json, mappings.js, dataTypes.json
- ✅ **Lógica de Execução**: Engines (Flow, Type, AutoExecution)
- ✅ **Methods**: 35+ implementações de nodes (processors, connectors, logic, etc.)
- ✅ **Utilities**: Funções auxiliares (unwrapData, deepClone, etc.)
- ✅ **Interfaces**: Contratos para adapters e extensões

## 🏗️ Estrutura

```
packages/core/src/
├── config/              # SINGLE SOURCE OF TRUTH
│   ├── nodes.json       # Catálogo completo de nodes (3611 linhas)
│   ├── mappings.js      # Mapeamentos de campos e sourceTypes
│   └── dataTypes.json   # Definições de tipos de dados
│
├── methods/             # 35 implementações de nodes
│   ├── comparison/      # Nodes de comparação (>, <, ==, etc.)
│   ├── connectors/      # Conectores externos (Sheets, APIs, etc.)
│   ├── constants/       # Valores constantes
│   ├── conversion/      # Conversão de tipos
│   ├── io/              # Input/Output
│   ├── iteration/       # Loops (forEach, while)
│   ├── logic/           # Lógica condicional
│   ├── organization/    # Markers e organização visual
│   ├── processors/      # 22 processadores (arrays, objects, math, etc.)
│   ├── storage/         # Variáveis e storage
│   └── string/          # Operações com strings
│
├── engine/              # Engines de execução
│   ├── FlowEngine.js    # Orquestra execução de flows
│   ├── TypeEngine.js    # Sistema de tipos
│   ├── AutoExecutionEngine.js  # Auto-execução
│   ├── registry.js      # Registro de methods
│   ├── loader.js        # Carregador de catálogo
│   └── executor.js      # Executor de nodes
│
├── utils/               # Utilitários
│   └── dataUtils.js     # unwrapData, wrapData
│
├── interfaces/          # Contratos
│   ├── IDataSource.js
│   └── IOutputDestination.js
│
└── contracts/           # Schemas
    └── ConnectorConfig.js
```

## 🚀 Uso

### No Node.js (API)

```javascript
// CommonJS com dynamic import
const mappings = await import('@flow-forge/core/config/mappings.js')
const { unwrapData } = await import('@flow-forge/core/utils/dataUtils.js')

// Executar method
const method = await import('@flow-forge/core/methods/processors/math.js')
const result = method.add({ inputs: { a: 5, b: 3 } })
```

### No Browser (Frontend via Vite)

```javascript
// ES Modules com alias @flow-forge/core
import { FlowEngine } from '@flow-forge/core'
import { FRONTEND_TO_CANONICAL } from '@flow-forge/core/config/mappings.js'
import { unwrapData } from '@flow-forge/core/utils/dataUtils.js'

const engine = new FlowEngine()
```

## 📝 Arquivos Importantes

### config/nodes.json

Catálogo completo de todos os nodes disponíveis no FlowForge.

**Estrutura:**
```json
{
  "categories": [
    { "id": "processors", "name": "Processadores", "icon": "⚙️" }
  ],
  "nodes": [
    {
      "type": "math",
      "category": "processors",
      "name": "Math",
      "icon": "➕",
      "functions": ["add", "subtract", "multiply", "divide"],
      "inputs": [...],
      "outputs": [...]
    }
  ]
}
```

**Como obter:**
- Frontend: `GET /api/nodes` (servido pela API)
- API: Lê diretamente do arquivo com cache

### config/mappings.js

Mapeamentos de campos entre camadas (Frontend → Canonical → Service).

**Estrutura:**
```javascript
export const FRONTEND_TO_CANONICAL = {
  google_sheets: {
    sheetsUrl: 'spreadsheetUrl',
    sheetsConnectionId: 'connectionId'
  }
}

export const CANONICAL_TO_SERVICE = {
  google_sheets: {
    spreadsheetUrl: 'url',
    connectionId: 'connectionId'
  }
}

export const SOURCE_TYPE_MAPPINGS = {
  toApi: { 'google_sheets': 'sheets' },
  fromApi: { 'sheets': 'google_sheets' }
}
```

### methods/[categoria]/[node].js

Implementação de cada node.

**Estrutura padrão:**
```javascript
import { unwrapData } from '../../utils/dataUtils.js'

/**
 * Função principal do node
 * @param {Object} params
 * @param {Object} params.nodeData - Configuração do node
 * @param {Object} params.inputs - Inputs recebidos
 * @param {Object} params.context - Contexto de execução
 * @returns {*} Resultado da execução
 */
export function add({ nodeData, inputs, context }) {
  const a = unwrapData(inputs.a)
  const b = unwrapData(inputs.b)
  return a + b
}

/**
 * Valida configuração do node (opcional)
 * @param {Object} nodeData
 * @returns {Object} { valid: boolean, errors: Array }
 */
export function validate(nodeData) {
  return { valid: true, errors: [] }
}
```

## 🔧 Desenvolvimento

### Adicionar Novo Node

Veja [CREATE_NODE.md](./CREATE_NODE.md) para guia completo.

**Resumo rápido:**

1. **Criar method** em `methods/[categoria]/[nome].js`
2. **Adicionar definição** em `config/nodes.json`
3. **Atualizar mappings** (se necessário) em `config/mappings.js`

### Executar Tests

```bash
cd packages/core
npm test
```

### Build

```bash
npm run build
```

## 🎯 Princípios

1. **Zero Dependencies**: Core não tem dependências externas
2. **Pure JavaScript**: Funciona em Node.js e Browser
3. **Single Source of Truth**: Toda configuração está no Core
4. **Stateless Methods**: Methods não mantém estado
5. **Type Safety**: Sistema de tipos robusto

## 🔄 Como outros pacotes usam o Core

### API (Node.js + CommonJS)

```javascript
// Dynamic import para acessar ES Modules do Core
const mappings = await import('@flow-forge/core/config/mappings.js')

// Cache para performance
let CANONICAL_TO_SERVICE_FIELDS = null

async function loadMappingsFromCore() {
  if (!CANONICAL_TO_SERVICE_FIELDS) {
    const mappings = await import('@flow-forge/core/config/mappings.js')
    CANONICAL_TO_SERVICE_FIELDS = mappings.CANONICAL_TO_SERVICE
  }
  return { CANONICAL_TO_SERVICE_FIELDS }
}
```

### Frontend (Browser + Vite)

```javascript
// Vite alias configurado em vite.config.js
import { FlowEngine } from '@flow-forge/core'

// Busca nodes.json via API (não importa diretamente)
const response = await fetch('/api/nodes')
const { data: nodes } = await response.json()
```

## 📚 Engines

### FlowEngine

Orquestra execução completa de flows.

```javascript
import { FlowEngine } from '@flow-forge/core'

const engine = new FlowEngine()
engine.setConfig({ apiUrl: 'http://localhost:3001' }, { var1: 'value' })

const result = await engine.executeFlow(nodes, edges)
```

### TypeEngine

Gerencia sistema de tipos e compatibilidade.

```javascript
import { TypeEngine } from '@flow-forge/core'

const typeEngine = new TypeEngine()
const type = typeEngine.detectType('node_1', 'output', { value: 42 })
const compatible = typeEngine.isTypeCompatible('string', 'any') // true
```

### AutoExecutionEngine

Decide quando nodes devem ser auto-executados.

```javascript
import { AutoExecutionEngine } from '@flow-forge/core'

const autoExec = new AutoExecutionEngine()
if (autoExec.shouldAutoExecute('constant', 'create')) {
  // Executar automaticamente
}
```

## 📄 License

MIT
